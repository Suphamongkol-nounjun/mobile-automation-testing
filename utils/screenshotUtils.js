import { PNG } from "pngjs";
import pixelmatch from "pixelmatch";
import { expect } from "chai";
import fs from "fs";
import AllureReporter from "@wdio/allure-reporter";

/**
 * ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå
 * @param {WebdriverIO.Browser} driver - WebDriverIO driver instance
 * @param {string} testName - ‡∏ä‡∏∑‡πà‡∏≠ Test Case ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û
 */


export async function takeScreenshot(testName) {
  try {
    const screenshot = await browser.takeScreenshot(); // ‡πÉ‡∏ä‡πâ browser.takeScreenshot()
    const filePath = `./allure-results/${testName}-Screenshot.png`;

    fs.writeFileSync(filePath, Buffer.from(screenshot, "base64"));
    AllureReporter.addAttachment(`${testName} - Screenshot`, fs.readFileSync(filePath), "image/png");

    console.log(`‚úÖ Screenshot captured: ${filePath}`);
  } catch (error) {
    console.error(`‚ùå Error capturing screenshot for ${testName}:`, error);
  }

  }

  

export async function saveScreenshot(driver, testName) {
    const screenshot = await browser.takeScreenshot();
    const filePath = `./allure-results/${testName}-actual.png`;
    fs.writeFileSync(filePath, Buffer.from(screenshot, "base64"));
    AllureReporter.addAttachment(`${testName} - Screenshot`, fs.readFileSync(filePath), "image/png");
        
};



export function compareScreenshots(testName) {
  const expectedPath = `./allure-results/${testName}-expected.png`;
  const actualPath = `./allure-results/${testName}-actual.png`;
  const diffPath = `./allure-results/${testName}-diff.png`;

  if (fs.existsSync(expectedPath)) {
    const expected = PNG.sync.read(fs.readFileSync(expectedPath));
    const actual = PNG.sync.read(fs.readFileSync(actualPath));
    const { width, height } = expected;

    const diff = new PNG({ width, height });
    const numDiffPixels = pixelmatch(expected.data, actual.data, diff.data, width, height, {
      threshold: 0.2, // ‡∏õ‡∏£‡∏±‡∏ö sensitivity
      includeAA: false,
    });

    // üìå ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ Actual ‡∏Ç‡∏∂‡πâ‡∏ô Allure Report ‡πÄ‡∏™‡∏°‡∏≠
    AllureReporter.addAttachment(`${testName} - Actual Image`, fs.readFileSync(actualPath), "image/png");

    if (numDiffPixels > 0) {
      // üìå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå diff ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Allure ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á
      fs.writeFileSync(diffPath, PNG.sync.write(diff));

      AllureReporter.addAttachment(`${testName} - Expected Image`, fs.readFileSync(expectedPath), "image/png");
      AllureReporter.addAttachment(`${testName} - Diff Image`, fs.readFileSync(diffPath), "image/png");

      // üìå ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á ‡πÇ‡∏¢‡∏ô error
      expect(numDiffPixels, `There are visual differences in ${testName}!`).to.equal(0);
    }
  } else {
    // üìå ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ expected image ‚Üí ‡πÄ‡∏ã‡∏ü actual ‡πÄ‡∏õ‡πá‡∏ô baseline
    fs.copyFileSync(actualPath, expectedPath);
    console.log(`üìå No baseline image found for ${testName}. Saving current screenshot as baseline.`);

    // üìå ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ actual ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Allure Report
    AllureReporter.addAttachment(`${testName} - Screenshot`, fs.readFileSync(actualPath), "image/png");
  }
}

export async function captureAndCompareScreenshot(testName) {
    const screenshot = await browser.takeScreenshot();
    const actualPath = `./allure-results/${testName}-actual.png`;
    fs.writeFileSync(actualPath, Buffer.from(screenshot, "base64"));
    
    const expectedPath = `./allure-results/${testName}-expected.png`;
    const diffPath = `./allure-results/${testName}-diff.png`;

  if (fs.existsSync(expectedPath)) {
    const expected = PNG.sync.read(fs.readFileSync(expectedPath));
    const actual = PNG.sync.read(fs.readFileSync(actualPath));
    const { width, height } = expected;

    const diff = new PNG({ width, height });
    const numDiffPixels = pixelmatch(expected.data, actual.data, diff.data, width, height, {
      threshold: 0.2, // ‡∏õ‡∏£‡∏±‡∏ö sensitivity
      includeAA: false,
    });

    // üìå ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ Actual ‡∏Ç‡∏∂‡πâ‡∏ô Allure Report ‡πÄ‡∏™‡∏°‡∏≠
    AllureReporter.addAttachment(`${testName} - Actual Image`, fs.readFileSync(actualPath), "image/png");

    if (numDiffPixels > 0) {
      // üìå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå diff ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ Allure ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á
      fs.writeFileSync(diffPath, PNG.sync.write(diff));

      AllureReporter.addAttachment(`${testName} - Expected Image`, fs.readFileSync(expectedPath), "image/png");
      AllureReporter.addAttachment(`${testName} - Diff Image`, fs.readFileSync(diffPath), "image/png");

      // üìå ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á ‡πÇ‡∏¢‡∏ô error
      expect(numDiffPixels, `There are visual differences in ${testName}!`).to.equal(0);
    }
  } else {
    // üìå ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ expected image ‚Üí ‡πÄ‡∏ã‡∏ü actual ‡πÄ‡∏õ‡πá‡∏ô baseline
    fs.copyFileSync(actualPath, expectedPath);
    console.log(`üìå No baseline image found for ${testName}. Saving current screenshot as baseline.`);

    // üìå ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ actual ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Allure Report
    AllureReporter.addAttachment(`${testName} - Screenshot`, fs.readFileSync(actualPath), "image/png");
  }
}
